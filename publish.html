<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>PHP发布流程 by icesyc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">PHP发布流程</h1>
      <h2 class="project-tagline"></h2>
    </section>

    <section class="main-content">
      <p>本文档描述了整个发布周期应该遵守的规范，统一和规范发布流程，提高发布效率，减小发布过程中可能出现的问题。</p>

<h2>
<a id="整体开发和发布的流程" class="anchor" href="#%E6%95%B4%E4%BD%93%E5%BC%80%E5%8F%91%E5%92%8C%E5%8F%91%E5%B8%83%E7%9A%84%E6%B5%81%E7%A8%8B" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>整体开发和发布的流程</h2>

<p>开发同学在自己的本地开发和自测 -&gt; 同步代码到测试环境测试 -&gt; 发布到预发布验证 -&gt; 发布到线上</p>

<h2>
<a id="开发环境准备" class="anchor" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>开发环境准备</h2>

<p>目前我们使用yii2框架进行开发，使用svn管理代码，使用deployer发布，所以需要在自己的机器上安装svn, deployer，由于在部署测试环境的环节使用了rsync，所以还需要安装cygwin环境才能使用。</p>

<h3>
<a id="安装cygwin" class="anchor" href="#%E5%AE%89%E8%A3%85cygwin" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>安装cygwin</h3>

<p>下载地址：<a href="https://cygwin.com/setup-x86.exe%E3%80%82">https://cygwin.com/setup-x86.exe。</a></p>

<p>下载后按提示安装，在选择软件包的时候，需要确认将rsync勾选，然后安装。</p>

<p>安装成功后会在桌面生成一个快捷方式，双击即可打开，打开后可以通过执行rsync命令测试是否安装成功。</p>

<h3>
<a id="安装deployer" class="anchor" href="#%E5%AE%89%E8%A3%85deployer" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>安装deployer</h3>

<p>下载地址：<a href="http://deployer.org/deployer.phar%E3%80%82">http://deployer.org/deployer.phar。</a></p>

<p>下载后，将deployer.phar改名为dep放到cygwin的bin目录下。</p>

<p>启动cygwin，执行dep命令，测试是否安装成功。</p>

<h2>
<a id="发布" class="anchor" href="#%E5%8F%91%E5%B8%83" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>发布</h2>

<h3>
<a id="部署测试环境" class="anchor" href="#%E9%83%A8%E7%BD%B2%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>部署测试环境</h3>

<p>将代码同步的测试环境时，先在cygwin环境下进入到本地的项目目录，然后执行</p>

<pre><code>dep rsync
</code></pre>

<p>该命令会使用rsync将代码直接部署到测试环境，避免每次都上传大量的文件，同会同步有改功的文件。</p>

<h3>
<a id="部署到预发和线上环境" class="anchor" href="#%E9%83%A8%E7%BD%B2%E5%88%B0%E9%A2%84%E5%8F%91%E5%92%8C%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>部署到预发和线上环境</h3>

<p>线上和预发环境保持一致的配置，使用相同的数据库源，在部署到预发和线上环境时，需要先提交代码到trunk上，发布使用如下命令：</p>

<p>发布到预发环境</p>

<pre><code>dep release pre
</code></pre>

<p>发布到线上环境</p>

<pre><code>dep release prod
</code></pre>

<p>部署到预发和线上环境除了服务器的ip地址不同，其它完全相同，该命令将会执行下面几个步骤</p>

<ol>
<li>登录到对应的服务器上</li>
<li>将svn trunk上的代码打tag，tag的名称为当天日期，如20160623</li>
<li>将对应的tag版本导出到服务器的临时目录下</li>
<li>执行环境初始化脚本，将environment目录的配置复制到对应目录下</li>
<li>将准备好的代码rsync到部署目录</li>
<li>删除临时目录</li>
</ol>

<h3>
<a id="注意事项" class="anchor" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>注意事项</h3>

<p>为了减少发布中出现的问题，配置文件做了如下规范</p>

<ol>
<li>db,cache,redis的配置应该在common/config/main-local.php中，不能放到其它文件中。</li>
<li>log的配置在各个模块的config/main.php中，除非有特殊需求，否则请不要修改。</li>
<li>在本地测试时，统一使用mysql的root空密码来连接，防止由于开发环境不一样导致开发的配置文件不同。</li>
<li>在需要增加配置信息时，如果配置是根据环境变化的，请写到main-local.php中，参数写到param-local.php中，并需要同时修改environment目录下对应的文件。</li>
</ol>

      <footer class="site-footer">

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
